const query=e=>Object.keys(e).map((o=>encodeURIComponent(o)+"="+encodeURIComponent(e[o]))).join("&"),markdown=window.markdownit(),message_box=document.getElementById("messages"),message_input=document.getElementById("message-input"),box_conversations=document.querySelector(".top"),spinner=box_conversations.querySelector(".spinner"),stop_generating=document.querySelector(".stop_generating"),send_button=document.querySelector("#send-button");let prompt_lock=!1;const format=e=>e.replace(/(?:\r\n|\r|\n)/g,"<br>");message_input.addEventListener("blur",(()=>{window.scrollTo(0,0)})),message_input.addEventListener("focus",(()=>{document.documentElement.scrollTop=document.documentElement.scrollHeight}));const delete_conversations=async()=>{localStorage.clear(),await new_conversation()},handle_ask=async()=>{message_input.style.height="80px",message_input.focus(),window.scrollTo(0,0);let e=message_input.value;e.length>0&&(message_input.value="",await ask_gpt(e))},remove_cancel_button=async()=>{stop_generating.classList.add("stop_generating-hiding"),setTimeout((()=>{stop_generating.classList.remove("stop_generating-hiding"),stop_generating.classList.add("stop_generating-hidden")}),300)},ask_gpt=async e=>{try{message_input.value="",message_input.innerHTML="",message_input.innerText="",add_conversation(window.conversation_id,e.substr(0,20)),window.scrollTo(0,0),window.controller=new AbortController,jailbreak=document.getElementById("jailbreak"),model=document.getElementById("model"),prompt_lock=!0,window.text="",window.token=message_id(),stop_generating.classList.remove("stop_generating-hidden"),message_box.innerHTML+=`\n            <div class="message">\n                <div class="user">\n                    ${user_image}\n                    <i class="fa-regular fa-phone-arrow-up-right"></i>\n                </div>\n                <div class="content" id="user_${token}"> \n                    ${format(e)}\n                </div>\n            </div>\n        `,message_box.scrollTop=message_box.scrollHeight,window.scrollTo(0,0),await new Promise((e=>setTimeout(e,500))),window.scrollTo(0,0),message_box.innerHTML+=`\n            <div class="message">\n                <div class="user">\n                    ${gpt_image} <i class="fa-regular fa-phone-arrow-down-left"></i>\n                </div>\n                <div class="content" id="gpt_${window.token}">\n                    <div id="cursor"></div>\n                </div>\n            </div>\n        `,message_box.scrollTop=message_box.scrollHeight,window.scrollTo(0,0),await new Promise((e=>setTimeout(e,1e3))),window.scrollTo(0,0);const o=(await fetch("https://chat.shuttle.rip/backend-api/v2/conversation",{method:"POST",signal:window.controller.signal,headers:{"content-type":"application/json",accept:"text/event-stream"},body:JSON.stringify({conversation_id:window.conversation_id,action:"_ask",model:model.options[model.selectedIndex].value,jailbreak:jailbreak.options[jailbreak.selectedIndex].value,meta:{id:window.token,content:{conversation:await get_conversation(window.conversation_id),internet_access:document.getElementById("switch").checked,content_type:"text",parts:[{content:e,role:"user"}]}}})})).body.getReader();for(;;){const{value:e,done:n}=await o.read();if(n)break;chunk=(new TextDecoder).decode(e),chunk.includes('<form id="challenge-form" action="https://chat.shuttle.rip/backend-api/v2/conversation?')&&(chunk="cloudflare token expired, please refresh the page."),text+=chunk,document.getElementById(`gpt_${window.token}`).innerHTML=markdown.render(text),document.querySelectorAll("code").forEach((e=>{hljs.highlightElement(e)})),window.scrollTo(0,0),message_box.scrollTo({top:message_box.scrollHeight,behavior:"auto"})}text.includes("instead. Maintaining this website and API costs a lot of money")&&(document.getElementById(`gpt_${window.token}`).innerHTML="An error occured, please reload / refresh cache and try again."),add_message(window.conversation_id,"user",e),add_message(window.conversation_id,"assistant",text),message_box.scrollTop=message_box.scrollHeight,await remove_cancel_button(),prompt_lock=!1,await load_conversations(20,0),window.scrollTo(0,0)}catch(o){add_message(window.conversation_id,"user",e),message_box.scrollTop=message_box.scrollHeight,await remove_cancel_button(),prompt_lock=!1,await load_conversations(20,0),console.log(o);let n=document.getElementById("cursor");if(n&&n.parentNode.removeChild(n),"AbortError"!=o.name){let e="oops ! something went wrong, please try again / reload. [stacktrace in console]";document.getElementById(`gpt_${window.token}`).innerHTML=e,add_message(window.conversation_id,"assistant",e)}else document.getElementById(`gpt_${window.token}`).innerHTML+=" [aborted]",add_message(window.conversation_id,"assistant",text+" [aborted]");window.scrollTo(0,0)}},clear_conversations=async()=>{const e=box_conversations.childNodes;let o=e.length;if(o>0)for(;o--;){const n=e[o];n.nodeType===Node.ELEMENT_NODE&&"button"!==n.tagName.toLowerCase()&&box_conversations.removeChild(n)}},clear_conversation=async()=>{let e=message_box.getElementsByTagName("div");for(;e.length>0;)message_box.removeChild(e[0])},delete_conversation=async e=>{localStorage.removeItem(`conversation:${e}`),window.conversation_id==e&&await new_conversation(),await load_conversations(20,0,!0)},set_conversation=async e=>{history.pushState({},null,`/chat/${e}`),window.conversation_id=e,await clear_conversation(),await load_conversation(e),await load_conversations(20,0,!0)},new_conversation=async()=>{history.pushState({},null,"/chat/"),window.conversation_id=uuid(),await clear_conversation(),await load_conversations(20,0,!0)},load_conversation=async e=>{let o=await JSON.parse(localStorage.getItem(`conversation:${e}`));for(item of(console.log(o,e),o.items))message_box.innerHTML+=`\n            <div class="message">\n                <div class="user">\n                    ${"assistant"==item.role?gpt_image:user_image}\n                    ${"assistant"==item.role?'<i class="fa-regular fa-phone-arrow-down-left"></i>':'<i class="fa-regular fa-phone-arrow-up-right"></i>'}\n                </div>\n                <div class="content">\n                    ${"assistant"==item.role?markdown.render(item.content):item.content}\n                </div>\n            </div>\n        `;document.querySelectorAll("code").forEach((e=>{hljs.highlightElement(e)})),message_box.scrollTo({top:message_box.scrollHeight,behavior:"smooth"}),setTimeout((()=>{message_box.scrollTop=message_box.scrollHeight}),500)},get_conversation=async e=>(await JSON.parse(localStorage.getItem(`conversation:${e}`))).items,add_conversation=async(e,o)=>{null==localStorage.getItem(`conversation:${e}`)&&localStorage.setItem(`conversation:${e}`,JSON.stringify({id:e,title:o,items:[]}))},add_message=async(e,o,n)=>{before_adding=JSON.parse(localStorage.getItem(`conversation:${e}`)),before_adding.items.push({role:o,content:n}),localStorage.setItem(`conversation:${e}`,JSON.stringify(before_adding))},load_conversations=async(e,o,n)=>{let t=[];for(let e=0;e<localStorage.length;e++)if(localStorage.key(e).startsWith("conversation:")){let o=localStorage.getItem(localStorage.key(e));t.push(JSON.parse(o))}for(conversation of(await clear_conversations(),t))box_conversations.innerHTML+=`\n            <div class="convo">\n                <div class="left" onclick="set_conversation('${conversation.id}')">\n                    <i class="fa-regular fa-comments"></i>\n                    <span class="convo-title">${conversation.title}</span>\n                </div>\n                <i onclick="delete_conversation('${conversation.id}')" class="fa-regular fa-trash"></i>\n            </div>\n        `;document.querySelectorAll("code").forEach((e=>{hljs.highlightElement(e)}))};function h2a(e){for(var o=e.toString(),n="",t=0;t<o.length;t+=2)n+=String.fromCharCode(parseInt(o.substr(t,2),16));return n}document.getElementById("cancelButton").addEventListener("click",(async()=>{window.controller.abort(),console.log(`aborted ${window.conversation_id}`)}));const uuid=()=>`xxxxxxxx-xxxx-4xxx-yxxx-${Date.now().toString(16)}`.replace(/[xy]/g,(function(e){var o=16*Math.random()|0;return("x"==e?o:3&o|8).toString(16)})),message_id=()=>(random_bytes=(Math.floor(1338377565*Math.random())+2956589730).toString(2),unix=Math.floor(Date.now()/1e3).toString(2),BigInt(`0b${unix}${random_bytes}`).toString());window.onload=async()=>{conversations=0;for(let e=0;e<localStorage.length;e++)localStorage.key(e).startsWith("conversation:")&&(conversations+=1);0==conversations&&localStorage.clear(),await setTimeout((()=>{load_conversations(20,0)}),1),window.location.href.endsWith("#")||/\/chat\/.+/.test(window.location.href)&&await load_conversation(window.conversation_id),message_input.addEventListener("keydown",(async e=>{prompt_lock||(13!==e.keyCode||e.shiftKey?(message_input.style.removeProperty("height"),message_input.style.height=message_input.scrollHeight+4+"px"):(console.log("pressed enter"),await handle_ask()))})),send_button.addEventListener("click",(async()=>{console.log("clicked send"),prompt_lock||await handle_ask()}))},document.querySelector(".mobile-sidebar").addEventListener("click",(e=>{const o=document.querySelector(".conversations");o.classList.contains("shown")?(o.classList.remove("shown"),e.target.classList.remove("rotated")):(o.classList.add("shown"),e.target.classList.add("rotated")),window.scrollTo(0,0)}));